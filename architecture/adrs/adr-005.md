## ADR 005: Vitest (Testing Framework)

## Context

We need a fast, modern, and developer-friendly testing framework for both unit and integration tests in a full-stack Next.js (using App Router) application. Some requirements include:

- Easy automation via npm scripts and future CI (GitHub Actions)
- Watch mode that stays open and re-runs tests on file changes for tight feedback loops
- High compatibility with Jest APIs for developer familiarity and ecosystem reuse
- Good TypeScript and ESM support
- Support for both `jsdom` (component tests) and `node` environments (services, route handlers)

### Options

1) Vitest
2) Jest
3) Mocha + Chai + Sinon
4) Node’s built-in `node:test`
5) Playwright test runner (E2E only, not ideal for unit/integration)

## Decision

We will use Vitest as our primary testing framework for unit and integration tests.

Reasons:

1) CI and npm automation: Runs via simple npm scripts and easy to set up in GitHub Actions.
2) Auto re-tests: The test runner remains open and re-runs only affected tests on file changes, providing fast feedback.
3) Jest compatibility: Almost drop-in Jest API tests. Lower learning curve and easier migration of examples/snippets.
4) Performance: Built on Vite’s pipeline with fast cold starts and incremental test runs, which keeps feedback times low on larger suites.
5) TypeScript & ESM support: No extra transpilation layer needed, supports modern TS/ESM out of the box.
6) Web and Node.js environments: Offer many environment options, including `environment: 'jsdom'` for React component tests, `environment: 'node'` for services, repositories, and route handlers.
7) Tooling ecosystem: Integrates cleanly with React Testing Library, Supertest (for API handlers), coverage tests, etc.
8) Clean config: One config file `vitest.config.ts` to define aliases (matching Next.js/tsconfig paths), setup files, environment per-project, and reporters.
9) Well-supported: Widely used, strong community, and fits into the modern Vite-based tooling landscape.

## Status

Accepted

## Consequences

By choosing to use Vitest as our testing framework, we have added `vitest` as a development dependency to our project, and created a configuration file to manage its settings. However, this means that we need to decide which environment to use for different types of tests (e.g., `jsdom` for component tests, which has more features but loads slower, and `node` for backend-only services, which is faster but limited to backend only).

The decision also means that we will likely have to decide on another testing framework later down the line for end-to-end (E2E) tests. We might consider using Playwright, or other E2E-focused tools, but this means that we will have two different testing frameworks in our stack that we need to maintain and implement in our CI/CD pipelines.

## Potential Backups

- Jest: Mature ecosystem and broad plugin support, but slower startup and TS/ESM friction compared to Vitest in our stack.
- Node `node:test`: Minimal dependency surface and built-in, but lacks certain features without assembling more tooling.
- Mocha + Chai + Sinon: Highly customizable but requires assembling multiple tools, there would be more maintenance overhead without much added benefit for our use case.
